@model CinemaSystem.Models.ViewModels.CinemaHallVM
@using CinemaSystem.Models.Data.Enums

<div class="card shadow border-0 my-4">
    <div class="card-header bg-primary bg-gradient ml-0 py-3">
        <div class="row">
            <div class="col-12 text-center">
                <h2 class="text-white py-2">@(Model.CinemaHall.Id != 0 ? "Update" : "Configure") Cinema Hall</h2>
            </div>
        </div>
    </div>
    <div class="card-body p-4">
        <form method="post" class="row">
            <input asp-for="CinemaHall.Id" hidden />
            <input asp-for="CinemaHall.TotalSeats" id="totalSeatsHidden" hidden />
            @* Hidden field to store the JSON string of seat configurations *@
            <input type="hidden" asp-for="SeatLayoutData" id="layoutDataHidden" />

            <div class="col-md-7">
                <div class="border p-3">
                    @* Basic Info *@
                    <div class="form-floating py-2 col-12">
                        <input asp-for="CinemaHall.Name" class="form-control border-0 shadow" />
                        <label asp-for="CinemaHall.Name" class="ms-2"></label>
                        <span asp-validation-for="CinemaHall.Name" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="form-floating py-2 col-6">
                            <select asp-for="CinemaHall.CinemaId" asp-items="@Model.CinemaList" class="form-select border-0 shadow">
                                <option disabled selected>--Select Cinema--</option>
                            </select>
                            <label asp-for="CinemaHall.CinemaId" class="ms-2"></label>
                        </div>
                        <div class="form-floating py-2 col-6">
                            <select asp-for="CinemaHall.HallType" asp-items="Html.GetEnumSelectList<HallType>()" class="form-select border-0 shadow"></select>
                            <label asp-for="CinemaHall.HallType" class="ms-2"></label>
                        </div>
                    </div>

                    @* Seating Grid Config *@
                    <div class="row mt-3 bg-light p-3 rounded border">
                        <h6 class="text-muted border-bottom pb-2">Grid Dimensions & Legend</h6>
                        <div class="col-6">
                            <label class="small text-muted">Total Rows (A-Z)</label>
                            <input asp-for="Rows" type="number" id="rowsInput" class="form-control shadow-sm" min="1" max="26" />
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">Columns per Row</label>
                            <input asp-for="Cols" type="number" id="colsInput" class="form-control shadow-sm" min="1" max="30" />
                        </div>

                        @* Interactive Legend *@
                        <div class="col-12 mt-3 d-flex justify-content-between border-top pt-2">
                            <small><span class="badge bg-secondary me-1">&nbsp;</span> Standard</small>
                            <small><span class="badge bg-success me-1">&nbsp;</span> Premium</small>
                            <small><span class="badge bg-warning text-dark me-1">&nbsp;</span> VIP</small>
                            <small><span class="badge bg-info text-dark me-1">&nbsp;</span> Handicap</small>
                        </div>
                        <div class="col-12">
                            <p class="text-muted small mt-2 mb-0 italic">Click on seats in the preview to cycle types.</p>
                        </div>
                    </div>

                    <div class="row pt-4">
                        <div class="col-6 col-md-4">
                            <button type="submit" class="btn btn-primary form-control">Save Hall & Layout</button>
                        </div>
                        <div class="col-6 col-md-3">
                            <a asp-action="Index" class="btn btn-outline-secondary border form-control">Back</a>
                        </div>
                    </div>
                </div>
            </div>

            @* Preview Section *@
            <div class="col-md-5">
                <div class="p-3 border rounded shadow-sm bg-white" style="min-height:450px;">
                    <h6 class="text-center text-primary mb-3">Interactive Seat Editor</h6>
                    <div class="w-75 mx-auto bg-dark text-white text-center mb-4 small py-1" style="border-radius: 0 0 15px 15px;">SCREEN</div>
                    <div id="seatingContainer" class="p-2 border bg-light rounded" style="user-select: none;"></div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const rowsInput = document.getElementById('rowsInput');
        const colsInput = document.getElementById('colsInput');
        const container = document.getElementById('seatingContainer');
        const hiddenTotal = document.getElementById('totalSeatsHidden');
        const layoutHidden = document.getElementById('layoutDataHidden');

        let seatMap = [];

        function renderGrid() {
            const r = parseInt(rowsInput.value) || 0;
            const c = parseInt(colsInput.value) || 0;
            hiddenTotal.value = r * c;

            // Try to parse existing data from the hidden field
            let existingData = [];
            try {
                if (layoutHidden.value) {
                    existingData = JSON.parse(layoutHidden.value);
                }
            } catch (e) { console.error("Invalid JSON in layout data"); }

            container.innerHTML = '';
            container.style.display = 'grid';
            container.style.gridTemplateColumns = `repeat(${c}, 1fr)`;
            container.style.gap = '6px';

            seatMap = [];

            for (let i = 0; i < r * c; i++) {
                const currentRow = String.fromCharCode(65 + Math.floor(i / c));
                const currentCol = (i % c) + 1;

                // Check if this specific seat exists in existingData
                const savedSeat = existingData.find(s => s.Row === currentRow && s.Col === currentCol);

                const seatData = {
                    Row: currentRow,
                    Col: currentCol,
                    Type: savedSeat ? savedSeat.Type : 1, // Use saved type or default to Standard
                    IsAcc: savedSeat ? savedSeat.IsAcc : false
                };
                seatMap.push(seatData);

                const seat = document.createElement('div');
                seat.className = "rounded shadow-sm text-center d-flex align-items-center justify-content-center cursor-pointer";
                seat.style.height = "22px";
                seat.style.fontSize = "10px";
                seat.style.cursor = "pointer";
                seat.innerText = `${currentRow}${currentCol}`;

                // Set initial color based on Type
                setSeatStyle(seat, seatData);

                seat.onclick = () => {
                    if (seatData.Type === 1 && !seatData.IsAcc) {
                        seatData.Type = 2; // Premium
                    }
                    else if (seatData.Type === 2) {
                        seatData.Type = 3; // VIP
                    }
                    else if (seatData.Type === 3) {
                        seatData.Type = 4; // Handicap
                        seatData.IsAcc = true;
                    }
                    else {
                        seatData.Type = 1; // Standard
                        seatData.IsAcc = false;
                    }
                    setSeatStyle(seat, seatData);
                    updateLayoutData();
                };

                container.appendChild(seat);
            }
            updateLayoutData();
        }

        function setSeatStyle(element, data) {
            element.style.color = "white";
            switch(data.Type) {
                case 1: // Standard
                    element.style.backgroundColor = "#6c757d";
                    break;
                case 2: // Premium
                    element.style.backgroundColor = "#198754";
                    break;
                case 3: // VIP
                    element.style.backgroundColor = "#ffc107";
                    element.style.color = "black";
                    break;
                case 4: // Handicap
                    element.style.backgroundColor = "#0dcaf0";
                    element.style.color = "black";
                    break;
            }
        }

        function updateLayoutData() {
            layoutHidden.value = JSON.stringify(seatMap);
        }

        // When the user manually changes Rows/Cols, we SHOULD reset the layout data
        // to avoid mismatching positions, OR you can keep it as is (current logic keeps matches).
        rowsInput.addEventListener('input', renderGrid);
        colsInput.addEventListener('input', renderGrid);

        window.onload = renderGrid;
    </script>

    <style>
        .cursor-pointer:hover {
            opacity: 0.8;
            transform: scale(1.1);
            transition: all 0.2s;
        }
    </style>
}