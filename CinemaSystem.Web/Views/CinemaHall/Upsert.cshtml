@model CinemaSystem.Models.ViewModels.CinemaHallVM
@using CinemaSystem.Models.Data.Enums

<div class="card shadow border-0 my-4">
    <div class="card-header bg-primary bg-gradient ml-0 py-3">
        <div class="row">
            <div class="col-12 text-center">
                <h2 class="text-white py-2">@(Model.CinemaHall.Id != 0 ? "Update" : "Configure") Cinema Hall</h2>
            </div>
        </div>
    </div>
    <div class="card-body p-4">
        @* Added Action and Controller explicitly to ensure mapping *@
        <form method="post" asp-action="Upsert" asp-controller="CinemaHall" class="row">
            <input asp-for="CinemaHall.Id" hidden />
            @* We need this so the model remains valid on POST *@
            <input asp-for="CinemaHall.TotalSeats" id="totalSeatsHidden" hidden />

            <div class="col-md-7">
                <div class="border p-3">
                    <div class="form-floating py-2 col-12">
                        <input asp-for="CinemaHall.Name" class="form-control border-0 shadow" />
                        <label asp-for="CinemaHall.Name" class="ms-2"></label>
                        <span asp-validation-for="CinemaHall.Name" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="form-floating py-2 col-6">
                            @* Added validation span for CinemaId *@
                            <select asp-for="CinemaHall.CinemaId" asp-items="@Model.CinemaList" class="form-select border-0 shadow">
                                <option disabled selected>--Select Cinema--</option>
                            </select>
                            <label asp-for="CinemaHall.CinemaId" class="ms-2"></label>
                            <span asp-validation-for="CinemaHall.CinemaId" class="text-danger"></span>
                        </div>
                        <div class="form-floating py-2 col-6">
                            <select asp-for="CinemaHall.HallType" asp-items="Html.GetEnumSelectList<HallType>()" class="form-select border-0 shadow">
                            </select>
                            <label asp-for="CinemaHall.HallType" class="ms-2"></label>
                        </div>
                    </div>

                    <div class="row mt-3 bg-light p-3 rounded">
                        <h6 class="text-muted border-bottom pb-2">Seating Configuration</h6>
                        <div class="col-6">
                            <label class="small text-muted">Rows</label>
                            <input asp-for="Rows" type="number" id="rowsInput" class="form-control" min="1" max="20" />
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">Seats per Row</label>
                            <input asp-for="Cols" type="number" id="colsInput" class="form-control" min="1" max="30" />
                        </div>
                    </div>

                    <div class="row pt-4">
                        <div class="col-6 col-md-3">
                            <button type="submit" class="btn btn-primary form-control">Save Hall</button>
                        </div>
                        <div class="col-6 col-md-3">
                            <a asp-action="Index" class="btn btn-outline-primary border form-control">Back</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="p-3 border rounded shadow-sm bg-white" style="min-height:400px;">
                    <h6 class="text-center text-primary mb-3">Layout Preview</h6>
                    <div class="w-75 mx-auto bg-dark text-white text-center mb-4 small py-1 shadow-sm" style="border-radius: 0 0 20px 20px;">
                        SCREEN
                    </div>
                    @* REMOVED d-flex and justify-content-center to allow Grid to work *@
                    <div id="seatingContainer" style="margin: 0 auto;">
                        @* Generated by JavaScript *@
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const rowsInput = document.getElementById('rowsInput');
        const colsInput = document.getElementById('colsInput');
        const container = document.getElementById('seatingContainer');
        const hiddenTotal = document.getElementById('totalSeatsHidden');

        function renderGrid() {
            const r = parseInt(rowsInput.value) || 0;
            const c = parseInt(colsInput.value) || 0;

            // Update the hidden field so the server receives the total seats
            hiddenTotal.value = r * c;

            container.innerHTML = '';
            container.style.display = 'grid';
            // 1fr ensures even spacing, but we cap the size so it doesn't overflow
            container.style.gridTemplateColumns = `repeat(${c}, minmax(10px, 25px))`;
            container.style.gap = '5px';
            container.style.justifyContent = 'center';

            for (let i = 0; i < r * c; i++) {
                const seat = document.createElement('div');
                seat.className = "bg-secondary rounded shadow-sm";
                seat.style.height = "20px";
                seat.style.width = "20px";
                container.appendChild(seat);
            }
        }

        rowsInput.addEventListener('input', renderGrid);
        colsInput.addEventListener('input', renderGrid);
        // Execute on load
        window.addEventListener('load', renderGrid);
    </script>
}